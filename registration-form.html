<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tenx Registration Form</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #ffe6ec;
        margin: 0;
        padding: 0;
        line-height: 1.5;
    }

    .container {
        width: 90%;
        max-width: 900px;
        margin: 30px auto;
        background: #fff;
        padding: 25px 35px;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    h2 {
        margin-top: 35px;
        margin-bottom: 10px;
        border-bottom: 2px solid #ddd;
        padding-bottom: 5px;
    }

    label {
        font-weight: bold;
        display: block;
        margin-top: 12px;
    }

    input, select, textarea {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
    }

    textarea { resize: vertical; }

    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .col { flex: 1; }

    .upload-box {
        border: 2px dashed #bbb;
        border-radius: 6px;
        padding: 25px;
        text-align: center;
        background: #fafafa;
        margin-top: 10px;
    }

    .submit-btn {
        margin-top: 25px;
        padding: 14px 24px;
        background: #007BFF;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
    }

    .note {
        color: red;
        margin-top: 12px;
        font-weight: bold;
    }

    .message {
        padding: 12px;
        margin-top: 15px;
        border-radius: 6px;
        display: none;
    }

    .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .message.show {
        display: block;
    }

    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: #6c757d;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        margin-bottom: 20px;
        transition: background 0.3s ease;
    }

    .back-btn:hover {
        background: #5a6268;
    }

    .back-btn:before {
        content: "‚Üê";
        font-size: 18px;
    }

    .otp-section {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        display: none;
    }

    .otp-section.active {
        display: block;
    }

    .otp-input-group {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        margin-top: 10px;
    }

    .otp-input-group input {
        flex: 1;
        max-width: 200px;
        margin-top: 0;
    }

    .send-otp-btn, .verify-otp-btn {
        padding: 10px 20px;
        background: #28a745;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        white-space: nowrap;
        transition: background 0.3s ease;
    }

    .send-otp-btn:hover, .verify-otp-btn:hover {
        background: #218838;
    }

    .send-otp-btn:disabled, .verify-otp-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .otp-timer {
        margin-top: 8px;
        font-size: 13px;
        color: #6c757d;
    }

    .otp-timer.expired {
        color: #dc3545;
        font-weight: bold;
    }

    .otp-success {
        color: #28a745;
        font-weight: bold;
        margin-top: 8px;
    }

    .otp-error {
        color: #dc3545;
        font-size: 13px;
        margin-top: 8px;
    }
</style>
</head>

<body>
<form id="registrationForm" method="POST" enctype="multipart/form-data">
<div class="container">
    <a href="index.html" class="back-btn">Back to Main Site</a>

    <h2>PERSONAL DETAILS</h2>

    <div class="row">
        <div class="col">
            <label>Gender *</label>
            <select name="gender" required>
                <option value="">Select Your Gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
            </select>
        </div>

        <div class="col">
            <label>Mobile Number *</label>
            <input type="text" name="mobile" required placeholder="Your Mobile Number" maxlength="10" pattern="[0-9]{10}">
        </div>

        <div class="col">
            <label>Date of Birth *</label>
            <div class="row">
                <div class="col">
                    <select name="dob_month" required>
                        <option value="">MM</option>
                        <option>01</option><option>02</option><option>03</option>
                        <option>04</option><option>05</option><option>06</option>
                        <option>07</option><option>08</option><option>09</option>
                        <option>10</option><option>11</option><option>12</option>
                    </select>
                </div>
                <div class="col">
                    <select name="dob_day" required>
                        <option value="">DD</option>
                        <!-- 1 to 31 -->
                        <option>01</option><option>02</option><option>03</option>
                        <option>04</option><option>05</option><option>06</option>
                        <option>07</option><option>08</option><option>09</option>
                        <option>10</option><option>11</option><option>12</option>
                        <option>13</option><option>14</option><option>15</option>
                        <option>16</option><option>17</option><option>18</option>
                        <option>19</option><option>20</option><option>21</option>
                        <option>22</option><option>23</option><option>24</option>
                        <option>25</option><option>26</option><option>27</option>
                        <option>28</option><option>29</option><option>30</option>
                        <option>31</option>
                    </select>
                </div>
                <div class="col">
                    <select name="dob_year" required>
                        <option value="">YYYY</option>
                        <option>1990</option><option>1991</option><option>1992</option>
                        <option>1993</option><option>1994</option><option>1995</option>
                        <option>1996</option><option>1997</option><option>1998</option>
                        <option>1999</option><option>2000</option><option>2001</option>
                        <option>2002</option><option>2003</option><option>2004</option>
                        <option>2005</option><option>2006</option><option>2007</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>WhatsApp Number *</label>
            <input type="text" name="whatsapp" required placeholder="Your WhatsApp Number">
        </div>

        <div class="col">
            <label>Email *</label>
            <input type="email" name="email" id="emailInput" required placeholder="Enter your email">
            <div class="otp-section" id="otpSection">
                <label>Email OTP Verification *</label>
                <div class="otp-input-group">
                    <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6" pattern="[0-9]{6}">
                    <button type="button" class="verify-otp-btn" id="verifyOtpBtn">Verify OTP</button>
                </div>
                <div class="otp-timer" id="otpTimer"></div>
                <div class="otp-success" id="otpSuccess" style="display: none;">‚úì OTP Verified Successfully!</div>
                <div class="otp-error" id="otpError"></div>
                <button type="button" class="send-otp-btn" id="resendOtpBtn" style="margin-top: 10px; display: none;">Resend OTP</button>
            </div>
            <button type="button" class="send-otp-btn" id="sendOtpBtn" style="margin-top: 10px; display: none;">Send OTP to Email</button>
            <label>Confirm Email *</label>
            <input type="email" name="confirm_email" required placeholder="Re-enter your email">
        </div>
    </div>

    <label>Applicant Name *</label>
    <input type="text" name="applicant_name" required>

    <label>Father's Name *</label>
    <input type="text" name="father_name" required>

    <label>State *</label>
    <input type="text" name="state" required>

    <label>Residential Address *</label>
    <textarea name="address" rows="3" required></textarea>

    <h2>ACADEMIC PROFILE</h2>

    <label>Education *</label>
    <select name="education" required>
        <option value="">Select Education</option>
        <option>10th</option>
        <option>12th</option>
        <option>Diploma</option>
        <option>Graduate</option>
        <option>Post Graduate</option>
        <option>PhD</option>
    </select>

    <label>Qualification *</label>
    <textarea name="qualification" rows="4" required></textarea>

    <h2>SKILLS</h2>
    <label>Skills *</label>
    <textarea name="skills" rows="4" required></textarea>

    <h2>UPLOAD DOCUMENTS</h2>

    <label>Photograph *</label>
    <div class="upload-box">
        <input type="file" name="photo" accept="image/*" required>
        <div>Max Size: 300 KB ‚Äî JPG/PNG</div>
    </div>

    <label>Marksheet (10/12th) *</label>
    <div class="upload-box">
        <input type="file" name="marksheet" accept=".pdf,.jpg,.jpeg,.png" required>
        <div>Max Size: 500 KB ‚Äî PDF/JPG/PNG</div>
    </div>

    <p class="note">A nominal application fee of ‚Çπ100 is required. Fully refundable upon joining.</p>

    <div id="message" class="message"></div>

    <button class="submit-btn" type="submit" id="submitBtn">Submit & Proceed to Payment</button>

</div>
</form>

<script>
/*
 * BACKEND API CONFIGURATION:
 * 
 * This frontend calls the backend API to send OTP emails via Brevo.
 * Make sure the backend server is running on the specified port.
 * 
 * For production, update API_BASE_URL to your deployed backend URL.
 */

const API_BASE_URL = 'http://localhost:5000';
const form = document.getElementById('registrationForm');
const submitBtn = document.getElementById('submitBtn');
const messageDiv = document.getElementById('message');
const STORAGE_KEY = 'tenx_registration_form_data';

// OTP Verification Variables
const emailInput = document.getElementById('emailInput');
const otpSection = document.getElementById('otpSection');
const otpInput = document.getElementById('otpInput');
const sendOtpBtn = document.getElementById('sendOtpBtn');
const verifyOtpBtn = document.getElementById('verifyOtpBtn');
const resendOtpBtn = document.getElementById('resendOtpBtn');
const otpTimer = document.getElementById('otpTimer');
const otpSuccess = document.getElementById('otpSuccess');
const otpError = document.getElementById('otpError');
let otpGenerated = null;
let otpExpiryTime = null;
let otpTimerInterval = null;
let isOtpVerified = false;

// Generate 6-digit OTP
function generateOTP() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

// Format timer display
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Start OTP timer (5 minutes = 300 seconds)
function startOTPTimer() {
    let timeLeft = 300; // 5 minutes
    
    otpTimerInterval = setInterval(() => {
        timeLeft--;
        otpTimer.textContent = `OTP expires in: ${formatTime(timeLeft)}`;
        
        if (timeLeft <= 0) {
            clearInterval(otpTimerInterval);
            otpTimer.textContent = 'OTP has expired. Please request a new one.';
            otpTimer.classList.add('expired');
            otpGenerated = null;
            resendOtpBtn.style.display = 'block';
        }
    }, 1000);
    
    otpTimer.textContent = `OTP expires in: ${formatTime(timeLeft)}`;
}

// Send OTP via Email using Backend API (Brevo)
async function sendOTP(email) {
    try {
        // Generate OTP
        otpGenerated = generateOTP();
        otpExpiryTime = Date.now() + (5 * 60 * 1000); // 5 minutes from now
        
        // Store OTP in sessionStorage
        sessionStorage.setItem('otp_' + email, otpGenerated);
        sessionStorage.setItem('otp_expiry_' + email, otpExpiryTime.toString());
        
        // Send OTP request to backend API
        try {
            const response = await fetch(`${API_BASE_URL}/send-otp`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                console.log('‚úÖ OTP email sent successfully to:', email);
                
                // In development mode, backend might return OTP for testing
                if (result.otp) {
                    console.log(`Development mode - OTP: ${result.otp}`);
                }
            } else {
                throw new Error(result.message || 'Failed to send OTP');
            }
        } catch (apiError) {
            console.error('Backend API error:', apiError);
            
            // Fallback: If backend is not available, show OTP in alert for testing
            console.warn('‚ö†Ô∏è Backend not available. Showing OTP in alert for testing.');
            alert(`Backend server not available.\n\nFor testing, OTP is: ${otpGenerated}\n\nPlease make sure the backend server is running on ${API_BASE_URL}`);
        }
        
        // Show OTP section
        otpSection.classList.add('active');
        sendOtpBtn.style.display = 'none';
        resendOtpBtn.style.display = 'none';
        otpInput.value = '';
        otpInput.focus();
        otpError.textContent = '';
        otpSuccess.style.display = 'none';
        isOtpVerified = false;
        
        // Start timer
        if (otpTimerInterval) clearInterval(otpTimerInterval);
        startOTPTimer();
        
        // Disable form submission until OTP is verified
        updateFormSubmissionState();
        
        return true;
    } catch (error) {
        console.error('Error sending OTP:', error);
        otpError.textContent = 'Failed to send OTP. Please try again.';
        return false;
    }
}

// Verify OTP
function verifyOTP() {
    const enteredOTP = otpInput.value.trim();
    const email = emailInput.value.trim();
    
    if (!enteredOTP || enteredOTP.length !== 6) {
        otpError.textContent = 'Please enter a valid 6-digit OTP.';
        return false;
    }
    
    // Get stored OTP
    const storedOTP = sessionStorage.getItem('otp_' + email);
    const storedExpiry = sessionStorage.getItem('otp_expiry_' + email);
    
    if (!storedOTP) {
        otpError.textContent = 'OTP not found. Please request a new OTP.';
        return false;
    }
    
    // Check if OTP expired
    if (storedExpiry && Date.now() > parseInt(storedExpiry)) {
        otpError.textContent = 'OTP has expired. Please request a new one.';
        otpGenerated = null;
        resendOtpBtn.style.display = 'block';
        return false;
    }
    
    // Verify OTP
    if (enteredOTP === storedOTP) {
        isOtpVerified = true;
        otpSuccess.style.display = 'block';
        otpError.textContent = '';
        otpInput.disabled = true;
        verifyOtpBtn.disabled = true;
        resendOtpBtn.style.display = 'none';
        
        if (otpTimerInterval) {
            clearInterval(otpTimerInterval);
            otpTimer.textContent = 'OTP Verified ‚úì';
        }
        
        // Enable form submission
        updateFormSubmissionState();
        
        // Clear OTP from storage
        sessionStorage.removeItem('otp_' + email);
        sessionStorage.removeItem('otp_expiry_' + email);
        
        return true;
    } else {
        otpError.textContent = 'Invalid OTP. Please try again.';
        return false;
    }
}

// Update form submission state based on OTP verification
function updateFormSubmissionState() {
    if (!isOtpVerified) {
        submitBtn.disabled = true;
        submitBtn.title = 'Please verify your email with OTP first';
    } else {
        submitBtn.disabled = false;
        submitBtn.title = '';
    }
}

// Email input handler
emailInput.addEventListener('input', function() {
    const email = this.value.trim();
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (email && emailRegex.test(email)) {
        sendOtpBtn.style.display = 'block';
        
        // Check if OTP was already verified for this email
        const verifiedEmail = sessionStorage.getItem('verified_email');
        if (verifiedEmail === email) {
            isOtpVerified = true;
            otpSection.classList.add('active');
            otpSuccess.style.display = 'block';
            otpInput.disabled = true;
            verifyOtpBtn.disabled = true;
            sendOtpBtn.style.display = 'none';
            resendOtpBtn.style.display = 'none';
            updateFormSubmissionState();
        } else {
            isOtpVerified = false;
            otpSection.classList.remove('active');
            otpSuccess.style.display = 'none';
            updateFormSubmissionState();
        }
    } else {
        sendOtpBtn.style.display = 'none';
        otpSection.classList.remove('active');
        isOtpVerified = false;
        updateFormSubmissionState();
    }
});

// Send OTP button click
sendOtpBtn.addEventListener('click', function() {
    const email = emailInput.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (email && emailRegex.test(email)) {
        sendOtpBtn.disabled = true;
        sendOtpBtn.textContent = 'Sending...';
        sendOTP(email).then(() => {
            sendOtpBtn.disabled = false;
            sendOtpBtn.textContent = 'Send OTP to Email';
        });
    }
});

// Resend OTP button click
resendOtpBtn.addEventListener('click', function() {
    const email = emailInput.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (email && emailRegex.test(email)) {
        resendOtpBtn.disabled = true;
        resendOtpBtn.textContent = 'Resending...';
        sendOTP(email).then(() => {
            resendOtpBtn.disabled = false;
            resendOtpBtn.textContent = 'Resend OTP';
        });
    }
});

// Verify OTP button click
verifyOtpBtn.addEventListener('click', function() {
    if (verifyOTP()) {
        const email = emailInput.value.trim();
        sessionStorage.setItem('verified_email', email);
    }
});

// Allow Enter key to verify OTP
otpInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        verifyOtpBtn.click();
    }
});

// Initialize form submission state
updateFormSubmissionState();

// Function to save form data to localStorage
function saveFormData() {
    const formData = new FormData(form);
    const data = {};
    
    // Save all form fields except file inputs
    for (let [key, value] of formData.entries()) {
        const field = form.querySelector(`[name="${key}"]`);
        // Skip file inputs as they can't be stored in localStorage
        if (field && field.type !== 'file') {
            data[key] = value;
        }
    }
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    console.log('üíæ Form data saved to localStorage');
}

// Function to restore form data from localStorage
function restoreFormData() {
    try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            const data = JSON.parse(savedData);
            console.log('üìÇ Restoring form data from localStorage:', data);
            
            // Restore all form fields
            Object.keys(data).forEach(key => {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    if (field.type === 'radio') {
                        // Handle radio buttons
                        const radio = form.querySelector(`[name="${key}"][value="${data[key]}"]`);
                        if (radio) radio.checked = true;
                    } else if (field.type === 'checkbox') {
                        // Handle checkboxes
                        field.checked = data[key] === 'on' || data[key] === true;
                    } else {
                        // Handle text, email, select, textarea
                        field.value = data[key];
                    }
                }
            });
            
            console.log('‚úÖ Form data restored successfully');
        }
    } catch (error) {
        console.error('‚ùå Error restoring form data:', error);
    }
}

// Function to clear saved form data
function clearFormData() {
    localStorage.removeItem(STORAGE_KEY);
    console.log('üóëÔ∏è Form data cleared from localStorage');
}

// Save form data whenever any field changes
form.addEventListener('input', saveFormData);
form.addEventListener('change', saveFormData);

function showMessage(text, type = 'success') {
    messageDiv.textContent = text;
    messageDiv.className = `message ${type} show`;
    setTimeout(() => {
        messageDiv.classList.remove('show');
    }, 5000);
}

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Check if OTP is verified
    if (!isOtpVerified) {
        showMessage('‚ùå Please verify your email with OTP before submitting the form.', 'error');
        otpSection.classList.add('active');
        if (otpInput.value.trim() === '') {
            otpInput.focus();
        } else {
            verifyOtpBtn.click();
        }
        return;
    }
    
    console.log('üìù Form submission started...');
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    // Clear previous messages
    messageDiv.classList.remove('show');
    
    try {
        // Get form data
        const formData = new FormData(form);
        
        // Log form data (for debugging)
        console.log('üìã Form data:', Object.fromEntries(formData));
        
        // Validate email match
        const email = formData.get('email');
        const confirmEmail = formData.get('confirm_email');
        
        if (email !== confirmEmail) {
            showMessage('‚ùå Email addresses do not match!', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit & Proceed to Payment';
            return;
        }
        
        // Submit form
        console.log('üì§ Submitting to:', `${API_BASE_URL}/submit`);
        
        const response = await fetch(`${API_BASE_URL}/submit`, {
            method: 'POST',
            body: formData
        });
        
        console.log('üì• Response status:', response.status);
        console.log('üì• Response headers:', response.headers);
        
        const result = await response.json();
        console.log('üì• Response data:', result);
        
        if (response.ok && result.success) {
            showMessage(`‚úÖ ${result.message || 'Form submitted successfully!'}\n\nSubmission ID: ${result.id}\n\nYour application has been saved.`, 'success');
            console.log('‚úÖ Form submitted successfully!', result);
            
            // Clear saved form data on successful submission
            clearFormData();
            
            // Clear OTP verification
            sessionStorage.removeItem('verified_email');
            isOtpVerified = false;
            otpSection.classList.remove('active');
            otpInput.value = '';
            otpInput.disabled = false;
            verifyOtpBtn.disabled = false;
            otpSuccess.style.display = 'none';
            sendOtpBtn.style.display = 'none';
            resendOtpBtn.style.display = 'none';
            if (otpTimerInterval) {
                clearInterval(otpTimerInterval);
                otpTimerInterval = null;
            }
            otpTimer.textContent = '';
            otpError.textContent = '';
            
            // Reset form after 3 seconds
            setTimeout(() => {
                form.reset();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit & Proceed to Payment';
                updateFormSubmissionState();
            }, 3000);
        } else {
            showMessage(`‚ùå Error: ${result.message || 'Failed to submit form. Please try again.'}`, 'error');
            console.error('‚ùå Form submission failed:', result);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit & Proceed to Payment';
        }
    } catch (error) {
        console.error('‚ùå Form submission error:', error);
        showMessage(`‚ùå Error: ${error.message || 'Failed to submit form. Please check if the backend server is running.'}`, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit & Proceed to Payment';
    }
});

// Restore form data and test backend connection on page load
window.addEventListener('DOMContentLoaded', async () => {
    // Restore saved form data first
    restoreFormData();
    
    // Check if email was previously verified
    setTimeout(() => {
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email && emailRegex.test(email)) {
            const verifiedEmail = sessionStorage.getItem('verified_email');
            if (verifiedEmail === email) {
                isOtpVerified = true;
                otpSection.classList.add('active');
                otpSuccess.style.display = 'block';
                otpInput.disabled = true;
                verifyOtpBtn.disabled = true;
                sendOtpBtn.style.display = 'none';
                resendOtpBtn.style.display = 'none';
                updateFormSubmissionState();
            } else {
                sendOtpBtn.style.display = 'block';
            }
        }
    }, 100);
    
    // Test backend connection
    try {
        const response = await fetch(`${API_BASE_URL}/health`);
        if (response.ok) {
            console.log('‚úÖ Backend server is running');
        } else {
            console.warn('‚ö†Ô∏è Backend server might not be running');
            showMessage('‚ö†Ô∏è Warning: Backend server might not be running. Please make sure the server is started.', 'error');
        }
    } catch (error) {
        console.error('‚ùå Cannot connect to backend server:', error);
        showMessage('‚ùå Error: Cannot connect to backend server. Please make sure the server is running at http://localhost:5000', 'error');
    }
});
</script>
</body>
</html>
